#!/usr/bin/env ruby

require 'tempfile'
require 'octodown'
require 'optparse'

include Octodown

options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: octodown [options]"

  opts.on("-s", "--style [STYLE]", [:github, :atom], "Choose style (atom, github)") do |s|
    options[:style] = s
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end.parse!

def open_in_browser(html)
  file = Tempfile.new ['octodown', '.html']

  begin
    file.write html
  ensure
    # Clear the buffer
    file.close
    `open #{file.path}`

    # Make sure browser has time to open before unlinking
    sleep 1
    file.unlink
  end
end

def create_html_from_md(filename, template)
  unstyled_html = Renderer::GithubMarkdown.new(filename).to_html
  Renderer::HTML.new(unstyled_html, template: template).render
end

html = create_html_from_md(ARGF.read, options[:style] || 'github')
open_in_browser html
